# React Code Splitting
We will now setup several React performance enhancements described as [Error Boundaries](https://reactjs.org/docs/error-boundaries.html) and [Code Splitting](https://reactjs.org/docs/code-splitting.html).  

## Changing To Code Splitting
There are three React methods that combined together make a powerful asynchronous loading and error catching performance upgrade.

### Lazy Loading
Rather than load all the application components when the `App` component loads, we utilize the React `lazy` method to load the component requirements only when they are needed.  
From:
```js
import React, { Component } from 'react';
import MyWidget from './path-to/MyWidget';
```
To:
```js
import React, { Component, lazy } from 'react';
const MyWidget = lazy(() => import('./path-to/MyWidget'));
```

### Suspense
The React `lazy` method asynchronously loads a component.  The React `Suspense` component allows you to provide a fallback UI while waiting on the component to load.  
From:
```js
import React, { Component } from 'react';
import MyWidget from './path-to/MyWidget';

function myComponent(props) {
  return (
    <MyWidget />
  );
}
```
To:
```js
import React, { Component, Suspense, lazy } from 'react';

const MyWidget = lazy(() => import('./path-to/MyWidget'));

function myComponent(props) {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <MyWidget />
    </Suspense>  
  );
}
```

### Error Boundaries
React [Error Boundary](https://reactjs.org/docs/error-boundaries.html) components allows you to provide a fallback UI when an error is detected within the child component tree.  
From:
```js
import React, { Component } from 'react';
import MyWidget from './path-to/MyWidget';

class myComponent extends Component {
  render() {
    return (
      <MyWidget />
    );
  }
}

export default myComponent;
```
To:
```js
import React, { Component, Suspense, lazy } from 'react';

const MyWidget = lazy(() => import('./path-to/MyWidget'));

class MyErrorBoundary extends Component {
  
  constructor(props) {
    super(props);
    this.state = {
      hasError: false,
      error: null
    };
  }
  
  componentDidCatch(error) {
    this.setState({
      hasError: true,
      error: error
    });
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="MyErrorBoundary">
          <h4>Oops, something went wrong :(</h4>
          <p>{this.state.error.toString()}</p>    
        </div>
      );
    }
    return this.props.children; 
  }  
} 

class myComponent extends Component {
  render() {
    return (
      <MyErrorBoundary>
        <Suspense fallback={<div>Loading...</div>}>
          <MyWidget />
        </Suspense>
      </MyErrorBoundary>
    );
  }
}

export default myComponent;

```

## Component Restructure For Code Splitting
Before our application gets more complex, we will reorganize our components and their directory structure for code splitting and scalability.  

### Refactor App Component
In order to keep our code easier to manage, lets move the three primary parts of the `App` component to their own components, `Navigation`, `Router` and `Footer`.
Replace the contents of `./src/App.js` with the following:
```js
import React, { Component } from 'react';
import './App.scss';
import Navigation from './components/Navigation';
import Router from './components/Router';
import Footer from './components/Footer';
import Api from './modules/Api';


class App extends Component {
  
  constructor(props) {
    super(props);
    this.state = {
      debug: true,
      isLoggedIn: false,
      currentUser: {}
    };
    this.refreshCurrentUser = this.refreshCurrentUser.bind(this);
    this.getData = this.getData.bind(this);
    this.refresh = this.refresh.bind(this);
    this.logout = this.logout.bind(this);
  }  

  async refreshCurrentUser() {
    try {
      let state = this.state;
      state.currentUser = await Api.getCurrentUser();
      state.isLoggedIn = Object.keys(state.currentUser).length > 0;
      if (this.state.debug) {
        console.log('App.refreshCurrentUser.state.currentUser', state.currentUser);
        console.log('App.refreshCurrentUser.state.isLoggedIn', state.isLoggedIn);
      }
      return state;
    } catch (error) {
      throw error;
    }    
  }

  async getData() {
    try {
      let state = await this.refreshCurrentUser();
      return state;
    } catch (error) {
      throw error;
    }
  }

  refresh() {
    this.getData()
    .then((result) => {
      this.setState(result);
    })
    .catch((error) => {
      console.error('App.js.componentDidMount', error);
    });
  }

  logout() {
    Api.logoutCurrentUser()
    .then(() => {
      this.refresh();
    });    
  }

  componentDidMount() {
    this.refresh();
  }

  render() {
    return (
      <div className="App">
        <div className="viewport-container">
          <Navigation isLoggedIn={this.state.isLoggedIn} logout={this.logout} />
          <Router {...this.state} refresh={this.refresh} />
        </div>
        <Footer />
      </div>
    );
  }
}

export default App;

```
Next we will create the new components from the terminal:
```bash
touch src/components/Navigation.jsx && touch src/components/Router.jsx && touch src/components/Footer.jsx
touch src/components/pages/Page.jsx && touch src/components/pages/RouteBoundary.jsx && touch src/components/pages/RouteMessageCard.jsx
```
Add the following content to `./src/components/Navigation.jsx`:
```js
import React, { Component } from 'react';
import { Navbar, NavbarLink, NavbarDropdown, NavbarDropdownLink } from './Bootstrap';
import logo from '../images/bionet-logo.png';

class Navigation extends Component {
  render () {
    return (
      <Navbar className="Navigation" brandImgSrc={logo} brandWidth="40">
        { this.props.isLoggedIn ? (
          <>
            <NavbarDropdown label="Account" icon="account" id="account-dropdown">
              <NavbarDropdownLink to="/profile" label="Profile" icon="account" />
              <button className="dropdown-item" onClick={this.props.logout}>
                <i className="mdi mdi-logout-variant mr-1" />Logout
              </button>
            </NavbarDropdown>
          </>
        ) : (
          <>
          <NavbarLink to="/login">
            <i className="mdi mdi-login-variant mr-1" />Login
          </NavbarLink> 
          <NavbarLink to="/signup">
            <i className="mdi mdi-account-plus mr-1" />Sign Up
          </NavbarLink> 
          </>
        )}
      <NavbarLink to="/about">About</NavbarLink>
    </Navbar>
    );
  }
}

export default Navigation;
```
Add the following content to `./src/components/Router.jsx`:
```js
import React, { Component, lazy } from 'react';
import { Switch, Route } from 'react-router-dom';
import Page from './pages/Page';
import RouteMessageCard from './pages/RouteMessageCard';

const Landing = lazy(() => import('./pages/Landing'));
const About = lazy(() => import('./pages/About'));
const Login = lazy(() => import('./pages/Login'));
const Signup = lazy(() => import('./pages/Signup'));
const Profile = lazy(() => import('./pages/Profile'));

class Router extends Component {
  render () {
    return (
      <div className="Router">
        <Switch>
          <Route exact path="/about" render={(props) => <Page {...props} PageComponent={About} /> } />
          <Route exact path="/login" render={(props) => <Page {...props} PageComponent={Login} /> } />
          <Route exact path="/signup" render={(props) => <Page {...props} PageComponent={Signup} /> } />
          <Route exact path="/profile" render={(props) => <Page {...props} PageComponent={Profile} /> } />
          <Route exact path="/" render={(props) => <Page {...props} PageComponent={Landing} /> } />
          <Route 
            render={(props) => (
              <RouteMessageCard
                icon="alert-circle"
                title="404 - Not Found"
                subtitle="Page Not Found"
                message="The content you have requested could not be found.  Please check the link and try again."
              />
            )}
          />
        </Switch>
      </div>
    );
  }
}

export default Router;
```
Add the following content to `./src/components/Footer.jsx`:
```js
import React, { Component } from 'react';
import { Link } from 'react-router-dom';
import { AppFooter } from './Bootstrap';

class Footer extends Component {
  render () {
    return (
      <AppFooter className="Footer text-center">
        <Link to="/about">Learn more</Link> about the bionet.
      </AppFooter>
    );
  }
}

export default Footer;
```
Add the following content to `./src/components/pages/Page.jsx`:
```js
import React, { Component, Suspense } from 'react';
import RouteBoundary from './RouteBoundary';
import RouteMessageCard from './RouteMessageCard';

class Page extends Component {
  render () {
    const PageComponent = this.props.PageComponent;
    return (
      <RouteBoundary>
        <Suspense fallback={<RouteMessageCard icon="timer-sand" title="Page Loading" message="Please be patient while the content loads..." />}>
          <PageComponent {...this.props} />
        </Suspense>
      </RouteBoundary>
    );
  }
}

export default Page;
```
Add the following content to `./src/components/pages/RouteBoundary.jsx`:
```js
import React, { Component } from 'react';
import { Container, Row, Column, Card } from '../Bootstrap';

class RouteBoundary extends Component {

  constructor(props) {
    super(props);
    this.state = {
      hasError: false,
      error: null
    };
  }

  componentDidCatch(error) {
    this.setState({
      hasError: true,
      error: error
    });
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="RouteBoundary">
          <Container>
            <Row>
              <Column col="12" colSm="10" colMd="6" colLg="5" className="ml-auto mr-auto">
                <Card icon="alert-circle" title="Error" className="mt-3">
                  <h4>Oops, something went wrong :(</h4>
                  <p>{this.state.error.toString()}</p>
                </Card>
              </Column>
            </Row>
          </Container>      
        </div>
      );
    }
    return this.props.children; 
  }

}

export default RouteBoundary;

```
Add the following content to `./src/components/pages/RouteMessageCard.jsx`:
```js
import React, { Component } from 'react';
import { Container, Row, Column, Card } from '../Bootstrap';

class RouteMessageCard extends Component {

  render() {
    return (
      <div className="RouteMessageCard">
        <Container>
          <Row>
            <Column col="12" colSm="10" colMd="6" colLg="5" className="ml-auto mr-auto">
              <Card icon={this.props.icon} title={this.props.title} className="mt-3">
                {this.props.subtitle && (
                  <h4>{this.props.subtitle}</h4>
                )}
                {this.props.message && (
                  <p>{this.props.message}</p>
                )}  
              </Card>
            </Column>  
          </Row>
        </Container>
      </div>
    );
  }

}

export default RouteMessageCard;

```